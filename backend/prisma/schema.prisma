generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model User {
  id        String   @id @default(uuid())
  username  String   @unique
  email     String   @unique
  password  String?
  
  // Profile Info
  name      String?
  country   String?
  city      String?
  bio       String?
  
  // Auth & Verification
  isVerified           Boolean   @default(false)
  verificationToken    String?
  resetPasswordToken   String?
  resetPasswordExpires DateTime?

  // OAuth Providers
  googleId   String?  @unique
  githubId   String?  @unique
  needsUsernameSetup  Boolean   @default(false)
  
  // Ratings & Stats
  rating        Int      @default(0)    // Contest Rating
  battleRating  Int      @default(1200) // Battle Rating (Default 1200 now)
  maxRating     Int      @default(0)
  
  brainType String?
  role      String   @default("USER")
  
  // Ban System
  isBanned   Boolean   @default(false)
  bannedAt   DateTime?
  banReason  String?
  
  // Profile Picture
  profilePicture String?
  
  lastVisit DateTime @default(now())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  // Relations
  submissions     Submission[]
  battle          BattleParticipant[]
  createdBattles  Battle[] @relation("BattleCreator")
  createdProblems Problem[] @relation("UserProblems")
  contests        Contest[]
  
  // Friends System (Self-relation)
  followedBy    User[]   @relation("UserFollows")
  following     User[]   @relation("UserFollows")
}

model Problem {
  id          String   @id @default(uuid())
  title       String
  description String
  difficulty  Int      // Keeps 1-3 for simple sorting, but rating is main
  rating      Int      @default(800) // Codeforces style: 800, 1000, 1200...
  category    String
  tags        String   // Comma separated
  testCases   String   // JSON: Supports Subtasks structure now
  timeLimit   Int      @default(1000) // ms
  memoryLimit Int      @default(256)  // MB
  isAiGenerated Boolean @default(false)
  externalSource String? // "Codeforces", "AtCoder", or null (Local)
  externalId     String? // e.g., "1234/A"
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  submissions Submission[]
  rounds      BattleRound[]
  createdBy   User? @relation("UserProblems", fields: [createdById], references: [id])
  createdById String?
  
  contests    Contest[] @relation("ContestProblems")
}

model Contest {
  id          String   @id @default(uuid())
  title       String
  description String?
  startTime   DateTime
  duration    Int      // in minutes
  status      String   @default("UPCOMING") // UPCOMING, RUNNING, FINISHED
  
  createdBy   User     @relation(fields: [createdById], references: [id])
  createdById String

  problems    Problem[] @relation("ContestProblems")
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model Submission {
  id        String   @id @default(uuid())
  code      String
  language  String
  status    String   // AC, WA, TLE, RE, CE
  score     Int      @default(0) // Points (0-100)
  runtime   Int      // ms
  memory    Int      // KB
  createdAt DateTime @default(now())
  
  // Relations
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId    String
  problem   Problem  @relation(fields: [problemId], references: [id])
  problemId String
  
  analysis  SubmissionAnalysis?
}

model SubmissionAnalysis {
  id           String     @id @default(uuid())
  submission   Submission @relation(fields: [submissionId], references: [id], onDelete: Cascade)
  submissionId String     @unique
  
  complexity   String?
  style        String?    // Stored as stringified JSON
  suggestions  String     // Stored as comma-separated string
  brainTypeData String?   // Stored as stringified JSON
  createdAt    DateTime   @default(now())
}

model Battle {
  id           String   @id @default(uuid())
  type         String   // "1v1", "team", "blitz", "mirror"
  status       String   // "waiting", "active", "finished"
  
  // Join System
  joinCode     String?  @unique // 6-digit code for private battles
  isPrivate    Boolean  @default(false) // true = invite only, false = public lobby
  
  // Matchmaking Filters
  minRating    Int?     // Minimum rating to join
  maxRating    Int?     // Maximum rating to join
  region       String?  // Region filter (optional)
  country      String?  // Country filter (optional)
  
  // Battle Settings
  duration     Int      @default(1800) // Battle duration in seconds (30 min default)
  problemCount Int      @default(5)    // Number of problems
  
  // Time Tracking
  startTime    DateTime?
  endTime      DateTime?
  createdAt    DateTime @default(now())
  
  // Creator
  createdBy    User     @relation("BattleCreator", fields: [createdById], references: [id], onDelete: Cascade)
  createdById  String
  
  // Relations
  participants BattleParticipant[]
  rounds       BattleRound[]
}

model BattleParticipant {
  id        String   @id @default(uuid())
  
  // Score & Rating
  score     Int      @default(0)       // Points earned in battle
  rank      Int?                       // Final rank in battle
  ratingChange Int   @default(0)       // ELO change (+/-)
  oldRating    Int?                    // Rating before battle (Null if first time/unrated)
  newRating    Int?                    // Rating after battle
  
  // Status
  status    String   @default("waiting") // "waiting", "ready", "active", "finished"
  joinedAt  DateTime @default(now())
  
  // Relations
  battle    Battle   @relation(fields: [battleId], references: [id], onDelete: Cascade)
  battleId  String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId    String
}

model BattleRound {
  id           String   @id @default(uuid())
  order        Int                      // Round number (1, 2, 3...)
  
  // Problem Assignment
  problemRating Int?                    // Target rating for problem selection
  duration      Int      @default(0)    // seconds (optional per problem limit)
  
  // Relations
  battle       Battle   @relation(fields: [battleId], references: [id], onDelete: Cascade)
  battleId     String
  problem      Problem  @relation(fields: [problemId], references: [id])
  problemId    String
}

model Announcement {
  id        String   @id @default(uuid())
  title     String
  content   String
  type      String   @default("INFO") // INFO, WARNING, IMPORTANT
  active    Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}
